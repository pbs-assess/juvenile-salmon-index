---
title: "Juvenile Chinook sdmTMB"
output: html_document
---

```{r setup, include=FALSE}
#knitr::opts_chunk$set(include = FALSE)
library(tidyverse)
library(sdmTMB)
library(ggplot2)

# downscale data and predictive grid
dat_trim <- readRDS(here::here("data", "chin_catch_sbc.rds")) %>% 
  mutate(utm_x_1000 = utm_x / 1000,
         utm_y_1000 = utm_y / 1000,
         survey_f = ifelse(
           year > 2016 & season_f == "su", "ipes", "hss") %>% as.factor()
         ) %>% 
  filter(!is.na(depth_mean_m),
         !is.na(dist_to_coast_km),
         !is.na(effort),
         # drop 1995 so that '96 doesn't have to be interpolated and 2022 since
         # it's IYS
         !year %in% c("1995", "2022"
                      ))

coast_utm <- rbind(rnaturalearth::ne_states( "United States of America", 
                                         returnclass = "sf"), 
               rnaturalearth::ne_states( "Canada", returnclass = "sf")) %>% 
  sf::st_crop(., 
              xmin = -137, ymin = 45.5, xmax = -121.25, ymax = 57) %>% 
  sf::st_transform(., crs = sp::CRS("+proj=utm +zone=9 +units=m"))
```

The goal is to develop a species distribution modeling framework that can be used to generate an annual abundance index for juvenile Chinook salmon (while accounting for changes in survey design) and also be used to predict spatial distributions in specific seasons to provide to various clients. Since these models will be parameterized with the same (or similar) data, but be structured in slightly different ways, will focus on the first component here.

The basic data are counts of juvenile Chinook from each tow, which are heavily skewed towards zeros and small values, which lends itself well to a negative binomial distribution.

```{r view_data, echo=TRUE}
hist(dat_trim$ck_juv, breaks = 100)
```

Ideally we'll incorporate environmental and survey variables that might influence Chinook salmon abundance. To keep things simple, the initial model includes a categorical variable for season, a categorical variable for survey (IPES if summer and after 2016, otherwise defined as high seas), and a smoother for distance to shore, which varies among seasons. I considered including bottom bathymetry, but it's fairly correlated with distance to shore. Similarly initial models that included a smooth seasonal parameter (e.g. month or week), failed to converge. 

I somewhat arbitrarily truncated the data around SEAK and excluded SoG data. While a lot of these samples are outside of the current IPES survey grid, the rationale is that including more data allows the model to better estimate the effect of covariates, which can then improve performance. Predictions (and the annual index of abundance) will be constrained to the IPES survey grid.

```{r spatial_catch, echo=TRUE}
ggplot() +
  geom_sf(data = coast_utm) +
  geom_point(data = dat_trim, aes(x = utm_x, y = utm_y, fill = survey_f), 
             shape = 21, alpha = 0.2) +
  facet_wrap(~season_f) +
  ggsidekick::theme_sleek()
```

Before fitting the model we create a mesh based on the sampling domain. I chose the cutoff (controls the spacing of the mesh) somewhat arbitrarily but preliminary fits suggest it doesn't strongly impact the predictions. 

```{r mesh1, echo=TRUE}
spde <- make_mesh(dat_trim, c("utm_x_1000", "utm_y_1000"), 
                   cutoff = 10, type = "kmeans")
plot(spde)
```

I next constrained the mesh with a boundary to force the model to exclude points on land when estimating spatial effects. According to Sean this may not actually be necessary and constrains some of the model structures we can use (I'll explore more).

```{r mesh2, echo = TRUE}
bspde <- add_barrier_mesh(
  spde, coast_utm, range_fraction = 0.1,
  # scaling = 1000 since UTMs were rescaled above
  proj_scaling = 1000, plot = TRUE
)

mesh_df_water <- bspde$mesh_sf[bspde$normal_triangles, ]
mesh_df_land <- bspde$mesh_sf[bspde$barrier_triangles, ]
ggplot(coast_utm) +
  geom_sf() +
  geom_sf(data = mesh_df_water, size = 1, colour = "blue") +
  geom_sf(data = mesh_df_land, size = 1, colour = "green") 
```

Besides the fixed effects noted above, the model includes temporal, spatial, and spatiotemporal parameters. In this case, the temporal parameters reflect annual variability. To ensure both survey effects and year effects are identifiable, year effects are assumed to be autoregressive (i.e. there is a correlation in Chinook abundance from year to year). The spatial effects reflect spatial patterns that are stable among years, while the spatiotemporal effects reflect spatial patterns that vary among years. This results in the following model structure (not run due to time constraints). 

```{r fit_model, echo=TRUE}
# don't run, import instead
fit_st_survey <- sdmTMB(ck_juv ~ s(dist_to_coast_km, by = season_f, k = 3) + 
                          season_f + survey_f,
              data = dat_trim,
              mesh = bspde,
              time = "year",
              family = nbinom2(link = "log"),
              spatial = "on",
              spatiotemporal = "ar1",
              do_fit = FALSE)

fit_st_survey <- readRDS(here::here("data", "fits", "fit_st_survey.RDS"))
```

Residuals and spatial residuals look good.

```{r check_resids, echo = TRUE}
dat_trim$resids <- residuals(fit_st_survey, type = "mle-laplace")
qqnorm(dat_trim$resids)
abline(b = 1, a = 0)

ggplot(dat_trim, aes(utm_x_1000, utm_y_1000, col = resids)) +
  scale_colour_gradient2() +
  geom_point() +
  facet_wrap(~year) +
  coord_fixed()
```


<!-- Fixed effects for distance to coast and season seem reasonable. -->

```{r cond_effs, echo=FALSE}
# season_p <- visreg::visreg(fit_st_survey, xvar = "season_f", 
#                            scale = "response")
# dist_p <- visreg::visreg(fit_st_survey, xvar = "dist_to_coast_km", 
#                          by = "season_f", xlim = c(0, 200), scale = "response")
```

As mentioned above, even though the model is parameterized using a larger spatial domain and data from all seasons, we can constrain predictions to focus on the current IPES survey grid and summer months. 

First are predicted counts including all fixed (survey, season, distance to coast), temporal (year), and random (spatial, spatio-temporal) effects. Note that the following predictions are for summer months with the observed survey structure (i.e. an effect for IPES is assumed after 2016), however the point of fitting these effects is to consider counterfactuals, for example what abundance would like if the same survey (spatial scope, vessel, etc) was applied after 2016. For now this is constrained to the index figures in following sections.

```{r spatial_preds, echo = TRUE}
# import spatial predictions
preds <- readRDS(
  here::here("data", "preds", "st_survey_spatial_preds.rds")
  ) 

preds_trim <- preds %>% 
  filter(season_f == "su", 
         survey_f == "hss")

# plotting function 
plot_map <- function(dat, column) {
  ggplot(dat, aes_string("utm_x_1000", "utm_y_1000", fill = column)) +
    geom_raster() +
    coord_fixed() +
    ggsidekick::theme_sleek()
}

plot_map(preds_trim, "exp(est)") +
  scale_fill_viridis_c(
    trans = "sqrt",
    # trim extreme high values to make spatial variation more visible
    na.value = "yellow", limits = c(0, quantile(exp(preds_trim$est), 0.995))
  ) +
  facet_wrap(~year) +
  ggtitle("Prediction (fixed effects + all random effects)") +
  theme(axis.text = element_blank(),
        axis.title = element_blank())
```

Fixed effects only aren't very informative here, but show the general relationship between distance to shore, survey, and abundance.

```{r spatial_preds2, echo = FALSE}
plot_map(preds, 
         "exp(est_non_rf)") +
  scale_fill_viridis_c(
    trans = "sqrt"
    ) +
  ggtitle("Prediction (fixed effects only)") +
  facet_wrap(~survey_f) +
  theme(axis.text = element_blank(),
        axis.title = element_blank())
```

Spatial random effects highlight regions of the survey grid with high/low abundance that is stable among years.

```{r spatial_preds3, echo = FALSE}
plot_map(preds_trim, "est_rf") +
  scale_fill_gradient2(
  ) +
  ggtitle("Prediction (spatial random effects only)")  +
  theme(axis.text = element_blank(),
        axis.title = element_blank())
```

Spatio-temporal random effects highlight regions of the survey grid with high/low abundance that varies among years.

```{r spatial_preds4, echo = FALSE}
plot_map(preds_trim, "epsilon_st") +
  scale_fill_gradient2() +
  facet_wrap(~year) +
  ggtitle("Prediction (spatiotemporal random effects)") +
  theme(axis.text = element_blank(),
        axis.title = element_blank())
```

Note that these maps are ideal for visualizing interannual variability in distributions, but are not the preferred way to provide estimates of "average" seasonal distributions to groups such as marine spatial planning (more on that below).

As noted above, the model was used to fit two abundance indices. The first assumes that survey effects are confounded with year (i.e. the IPES coefficient estimate is used after 2016), while the second assumes they can be separated and controlled for (i.e. the HSS coefficient is applied to the entire time series, though the IPES coefficient could also be used).

As you can see there is a reduction in biomass after 2016 that is amplified when survey effects are not accounted for. When they are biomass since the IPES survey began is more similar to the time series average.

```{r abund_index, echo = TRUE}
index_list <- readRDS(here::here("data", "preds", "st_survey_index_list.rds"))

index1 <- index_list[[1]] %>% mutate(survey = "hss")
index <- index_list[[2]] %>% 
  mutate(survey = "ipes") %>% 
  filter(year > 2016) %>% 
  rbind(., index1)

ggplot(index, aes(year, est)) +
  geom_ribbon(aes(ymin = lwr, ymax = upr, fill = survey), alpha = 0.2) +
  geom_line(aes(colour = survey), lwd = 1) +
  labs(x = "Year", y = "Count") +
  ggsidekick::theme_sleek()
```

### Outstanding issues
1. Identify suite of fixed covariates to include (e.g. additional bathymetry variables, headrope depth, granular temporal data instead of season); use VIF or equivalent to assess collinearity
2. Add distance traveled as a proxy for effort (use an offset)
3. Evaluate impacts of including anisotropy vs. including a boundary mesh
4. Evaluate impacts of fitting model to full dataset vs spatially/temporally constrained dataset (e.g. summer, IPES grid only)
5. Determine most appropriate way to account for changes in survey design
6. Does small estimate for rho invalidate independence of survey design effect and year effect?
7. Should index represent summer survey, fall or an "average" based on dummy variables? 
8. Investigate catch distribution in 2016 (anomalously high).

### Alternative model structure

To provide predictions of spatial distributions, rather than an index of abundance, similar environmental covariates should be used, but the model should be reparameterized. Specifically, I would recommend treating month/week as a temporal variable (and allowing spatial patterns to vary accordingly), while year would be treated as a random intercept (potentially with random walk or AR1 component). This would for predictions to be made for an "average" year and better capturing seasonal changes in abundance which likely vary spatially. The spatial domain of the prediction grid could also be expanded to provide information coastwide.