### Can fit parameters be recovered?
## Use simulated data generated by model in chinook_fit to determine whether key
## parameters can be reliably recovered.
## Sep 29, 2022

library(tidyverse)
library(sdmTMB)
library(ggplot2)


dat <- readRDS(here::here("data", "chin_catch_sbc.rds")) %>% 
  mutate(utm_x_1000 = utm_x / 1000,
         utm_y_1000 = utm_y / 1000,
         effort = log(distance_travelled),
         week = lubridate::week(date),
         vessel = as.factor(vessel)
  ) %>% 
  filter(
    !effort < 0,
    !is.na(effort)
  ) %>% 
  droplevels()
dat_in <- dat %>% filter(!year == "2022")

spde <- make_mesh(dat_in, c("utm_x_1000", "utm_y_1000"), 
                  cutoff = 10, type = "kmeans")


fit <- readRDS(here::here("data", "fits", "fit_st_full.rds"))



nsims = 25
sims_test <-  simulate(fit, nsim = nsims)

## for each simulated dataset, refit model, recover pars and store
# list of tidy data
tidy_pars_rand <- tidy_pars_fix <- vector(mode = "list", length = nsims)
for (i in seq_len(nsims)) {
  dat_in$sim_dat <- sims_test[, i]
  fit <- sdmTMB(
    sim_dat ~ 1 +  
      s(depth_mean_m, bs = "tp", k = 4) +
      # s(dist_to_coast_km, bs = "tp", k = 4) + 
      # s(month, bs = "cc", k = 4) +
      survey_f,
    offset = dat_in$effort,
    data = dat_in,
    mesh = spde,
    time = "year",
    # infill 1996
    extra_time = c(1996L),
    family = sdmTMB::nbinom2(),
    spatial = "on",
    spatiotemporal = "ar1",
    anisotropy = TRUE,
    priors = sdmTMBpriors(
      matern_s = pc_matern(range_gt = 2, sigma_lt = 5)
    )
  )
}