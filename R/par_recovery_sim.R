### Can fit parameters be recovered?
## Use simulated data generated by model in chinook_fit to determine whether key
## parameters can be reliably recovered.
## Sep 29, 2022
## Reran Oct 26: parameters recovered well for most species except range biased 
# high and headrope depth coefficients uncertain for chum in particular;
# consider rerunning with smooth for headrope, not cat. effects

library(tidyverse)
library(sdmTMB)
library(ggplot2)


# spatial data
coast_utm <- rbind(rnaturalearth::ne_states( "United States of America", 
                                             returnclass = "sf"), 
                   rnaturalearth::ne_states( "Canada", returnclass = "sf")) %>% 
  sf::st_crop(., 
              xmin = -137, ymin = 47, xmax = -121.25, ymax = 57) %>% 
  sf::st_transform(., crs = sp::CRS("+proj=utm +zone=9 +units=m"))

# fitted model
fit_all_sp <- readRDS(here::here("data", "fits", "st_mod_all_sp.rds")) %>% 
  mutate(
    bspde = purrr::map(spde, add_barrier_mesh,
                       coast_utm, range_fraction = 0.1,
                       # scaling = 1000 since UTMs were rescaled above
                       proj_scaling = 1000)
  )

nsims = 15
sims_list <- purrr::map(fit_all_sp$st_mod, simulate, nsim = nsims)


## for each simulated dataset, refit model, recover pars and store
library(furrr)
plan(multisession, workers = 6)


# make a tibble for each species simulations
sim_tbl <- purrr::pmap(
  list(fit_all_sp$species, fit_all_sp$data, sims_list), function (sp, dat, x) {
    tibble(
      species = sp,
      iter = seq(1, nsims, by = 1),
      sim_dat = lapply(seq_len(ncol(x)), function(i) {
        dat %>% 
          mutate(sim_catch = x[ , i])
      })
    )
  }
) %>% 
  bind_rows() %>% 
  left_join(., fit_all_sp %>% select(species, bspde), by = "species")

# dd <- sim_tbl[1:3, ] %>% 
#   mutate(
#     spde = purrr::map(sim_dat, make_mesh,  c("utm_x_1000", "utm_y_1000"),
#                       cutoff = 15, type = "kmeans"),
#     bspde = purrr::map(spde, add_barrier_mesh,
#                        coast_utm, range_fraction = 0.1,
#                        # scaling = 1000 since UTMs were rescaled above
#                        proj_scaling = 1000)
#   )
# glimpse(dd$bspde[[1]])
# glimpse(fit_all_sp$bspde[[1]])

sim_fit_list <- furrr::future_pmap(
  list(sim_tbl$sim_dat, sim_tbl$bspde), function (x, bspde_in) {
    sdmTMB(
      sim_catch ~ 1 +
        dist_to_coast_km + 
        s(week, bs = "cc", k = 5) +
        day_night +
        target_depth_bin +
        survey_f,
      offset = x$effort,
      data = x,
      mesh = bspde_in,
      family = sdmTMB::nbinom2(),
      spatial = "on",
      spatiotemporal = "AR1",
      time = "year",
      anisotropy = FALSE,
      priors = sdmTMBpriors(
        matern_s = pc_matern(range_gt = 10, sigma_lt = 80)
      ),
      control = sdmTMBcontrol(
        nlminb_loops = 2,
        newton_loops = 1
      )
    )
  }
)

sim_tbl$sim_fit <- sim_fit_list

# check one model's summary
summary(sim_tbl$sim_fit[[1]])

# extract fixed and ran effects pars from simulations
sim_tbl$pars <- purrr::map(
  sim_tbl$sim_fit, function (x) {
    # x <- sim_tbl$sim_fit[[2]]
    fix <- tidy(x, effects = "fixed")
    ran <- tidy(x, effects = "ran_pars")
    rbind(fix, ran) 
  }
)

sim_pars <- sim_tbl %>% 
  select(species, iter, pars) %>% 
  unnest(cols = c(pars)) %>% 
  mutate(iter = as.factor(iter),
         species = abbreviate(species, minlength = 3))
saveRDS(sim_pars, here::here("data", "preds", "sim_pars.rds"))


# as above but for fitted models
fit_effs <- purrr::map2(
  fit_all_sp$st_mod, fit_all_sp$species, function (x, sp) {
    fix <- tidy(x, effects = "fixed")
    ran <- tidy(x, effects = "ran_pars")
    rbind(fix, ran) %>% 
      mutate(species = abbreviate(sp, minlength = 3))
  }
) %>% 
  bind_rows() 

sim_box <- ggplot() +
  geom_boxplot(data = sim_pars, aes(x = species, y = estimate)) +
  geom_point(data = fit_effs, aes(x = species, y = estimate), colour = "red") +
  facet_wrap(~term, scales = "free") +
  ggsidekick::theme_sleek()

pdf(here::here("figs", "diagnostics", "par_recovery_sim_box.pdf"), 
    height = 7, width = 11)
sim_box
dev.off()
